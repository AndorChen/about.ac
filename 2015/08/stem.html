<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"/><title>在电子书中渲染公式 - Andor Chen</title><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="renderer" content="webkit"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/><meta name="description" content="安道的个人网站"/><meta name="author" content="安道"/><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/><link rel="stylesheet" href="/assets/style.css"/><script src="/assets/js/jquery-2.1.3.min.js"></script><script src="/assets/js/main.js"></script></head><body class="single-post-page"><div class="wrapper"><header id="site_header" class="header mobile-menu-hide"><div class="avatar"><a href="/" title="首页"><img src="/assets/images/panda.jpg" alt="Andor's Avatar"/></a><div class="mask"></div><!-- ? --></div><div class="site-title-block"><h1 class="site-title"><a href="/" title="首页">安道</a></h1><p class="site-description">高校教师<br/>自由翻译</p></div><div class="site-nav"><ul id="nav" class="site-main-menu"><li><a href="/" title="">首页</a></li><li><a href="/books/" title="">图书</a></li><li class="active"><a href="/archive/" title="">文章</a></li></ul><ul class="social-links"><li><a href="https://twitter.com/Andor_Chen" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li><li><a href="http://www.weibo.com/andor27/" title="微博" target="_blank"><i class="icon-weibo"></i></a></li><li><a href="https://github.com/AndorChen" title="GitHub" target="_blank"><i class="icon-github-circled"></i></a></li><li><a href="/feed.xml" title="订阅网站更新"><i class="icon-rss"></i></a></li></ul></div></header><div class="mobile-header mobile-visible"><div class="mobile-logo-container"><div class="mobile-site-title">安道</div></div><a class="menu-toggle mobile-visible"><i class="icon-menu"></i></a></div><div id="main" class="site-main"><div class="inner-main"><section class="section"><div class="section-header"><h1 class="section-title">博客文章</h1></div><div class="section-content"><div class="breadcrumbs"><a href="/" title="首页">首页</a> // <a href="/archive/" title="文章归档">文章归档</a></div><article class="hentry entry"><header class="entry-header"><h1 class="entry-title">在电子书中渲染公式</h1><p class="entry-meta">发布于2015年8月14日</p></header><div class="entry-content"><p>昨天更新了《<a href="http://railstutorial-china.org" title="Ruby on Rails 教程">Ruby on Rails 教程</a>》，这次更新最大的变化是对公式的处理方式。这本书有一节用了几个公式，我使用的电子书工具链之前不支持转换公式，所以只能做些简单的处理：使用上下标。后来越看越不舒服，因此前几天抽空实现了 LaTex 式的显示效果。</p><p>公式一直是我的电子书工具链所缺乏的功能之一，我也一直想解决，不过苦于没有合适的方法。前几天，O’Reilly 电子书方面的负责人（Sanders Kleinfeld）分享了<a href="http://diagramcenter.org/webinars.html#mmlc" title="他们的处理方式">他们的处理方式</a>，勾起了我解决这个问题的欲望。</p><p>按照 Sanders 的分享，我首先尝试使用 <a href="https://www.mathmlcloud.org/" title="MathML Cloud">MathML Cloud</a>。不过这个服务提供的 API 不规范，尝试过程中多次遇到问题。这个服务的实现方式是<a href="https://github.com/benetech/mmlc-api" title="开源">开源</a>的，不过自己搭建很麻烦，又是 MongoDB，又是 Redis 的，所以我放弃了这个方案。</p><p>随后我试着搜索，看有没有纯 Ruby 的解决方案，毕竟我的工具链是使用 Ruby 编写的。在 GitHub 中搜索，找到了 <a href="https://github.com/gjtorikian/mathematical" title="mathematical">mathematical</a>。这个 gem 为了提升“速度”，用了两个 C 语言扩展。正是这两个扩展让我放弃使用这个 gem。因为用到了 C 扩展，所以安装之前要先安装一些库，不过对于“新手”来说，这个过程像念咒语一样，根本不得要领，开发者说安装什么跟着做就是了，然而有时跟着做也没用。环境的差异害死人！在这个 gem 开发者的帮助下，成功编译了 C 扩展，可是使用过程中又遇到了问题：无法生成 SVG 和 png 图像。自己尝试解决无果后，我就放弃了这个 gem。</p><p>这时，我又想起了 MathML Cloud，既然这个服务的实现方式是开源的，不妨看看它是如何渲染公式的。看了<a href="https://github.com/benetech/mmlc-api/blob/1daa756cc68a2ab5b535410b3f968c9257e2400c/package.json#L26" title="代码">代码</a>，发现 MathML Cloud 使用的是 <a href="https://github.com/mathjax/MathJax-node" title="MathJax-node">MathJax-node</a>。<a href="https://www.mathjax.org/" title="MathJax">MathJax</a> 应该是目前最成熟的公式解决方案，既然有 Node.js 版，集成到我的工具链中就不难了，因为 MathJax-node 提供了 CLI。经过一番编程之后，最终顺利把 MathJax-node 集成到我的工具链中。</p><p>目前我是这样处理公式的：书稿中使用 LaTex 句法写公式（纯文本，便于管理），生成电子书时为不同的电子书格式生成不同格式的图像</p><ul><li>PDF 和 HTML 格式用 SVG</li><li>ePub 和 mobi 格式用 png</li></ul><p>这么做遵循了“渐进增强”原则，因为 PDF 骨子里就是“矢量”的，最适合使用 SVG，而且目前大多数主流浏览器都支持 SVG，所以 HTML 格式也用了 SVG。但是 ePub 阅读器和 Kindle 等对 SVG 的支持并不好，只能使用图像；虽然缩放时的体验不好，但是至少还能辨识公式的内容。</p><p>P.S. 我的电子书工具链是 <a href="https://rubygems.org/gems/persie" title="persie">persie</a>。这个工具之前是开源的，现在已经闭源，不过以前的版本仍然可以下载安装。</p></div><ul class="entry-tags"><li><a class="btn btn-default btn-sm" href="/tags/#ebook-ref" title="电子书">电子书</a></li></ul></article><ul class="pager"><li class="previous"><a rel="prev" href="/2015/08/docx-footnotes-numbering.html" title="docx 文件脚注的编号">&laquo; 上一篇文章</a></li><li class="next"><a rel="next" href="/2015/09/epub-best-practices.html" title="ePub 电子书排版最佳实践">下一篇文章 &raquo;</a></li></ul></div></section><footer class="footer"><p class="copyright">&copy;1988-。如无特殊说明，本站文章基于“<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" title="CC BY-NC-SA 3.0" target="_blank">CC BY-NC-SA 3.0</a>”协议发布。</p><p class="powered-by"><a href="http://jekyllrb.com" title="本站使用 Jekyll 生成" target="_blank"><img src="/assets/images/jekyll-logo@2x.png" width="60" height="24" alt="Jekyll Logo" title="本站使用 Jekyll 生成"/></a></p></footer></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69344223-1', 'auto');
  ga('send', 'pageview');</script></body></html>