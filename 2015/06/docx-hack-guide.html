<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>docx 文件定制指南 - Andor Chen</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="renderer" content="webkit" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="description" content="安道的个人网站" />
  <meta name="author" content="安道" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link type="application/atom+xml" rel="alternate" href="https://about.ac/feed.xml" title="Andor Chen" />
  <link rel="stylesheet" href="/_bridgetown/static/index.3XCROTRC.css" />
  <script src="/_bridgetown/static/index.3QSIHARC.js" defer></script>
  
</head>
<body class="bg-dracula-darker text-dracula-light">

<div class="px-6 py-8 md:px-16 lg:px-24 lg:py-16">
  
  <header class="max-w-prose mb-12">
    <div class="flex flex-row">
      <div class="basis-1/6 flex-auto"><a href="/" title="安道"><img src="/assets/images/painting.png" alt="Andor's Avatar" class="rounded-full w-32" /></a></div>
      <div class="basis-5/6 flex-auto self-center"><span class="pl-8 text-4xl font-medium"><a href="/" title="安道">安道</a></span></div>
    </div>
  </header>

  <main>

<div class="mb-4">
  <a href="/" title="首页">首页</a> // <a href="/archive/" title="文章归档">文章归档</a>
</div>


<article class="prose prose-invert">
  <header>
    <h1 class="text-dracula-purple">docx 文件定制指南</h1>
    <p>（发布于 2015 年 6 月 1 日）</p>
  </header>

  <main>
    <p>我在“<a href="{% post_url 2015-05-10-apps-for-translator%}">翻译时使用的应用</a>”一文中提到，因为最近翻译的一本书要求提供 <code class="highlighter-rouge">docx</code> 文件，所以我第一次使用了 <a href="http://pandoc.org/">pandoc</a>。</p>

<p>Pandoc 是个很强大的工具，能在多种文件格式之间相互转换。不过，我使用 Pandoc 只是为了把 Markdown 文件转换成 <code class="highlighter-rouge">docx</code> 文件，以便提供给出版社。Pandoc 能很好地完成这项工作，不过转换得到的 <code class="highlighter-rouge">docx</code> 文件格式不符合我的要求，所以最近几天稍微研究了定制样式的问题。</p>

<h2><code class="highlighter-rouge">docx</code> 格式简介</h2>

<p><code class="highlighter-rouge">docx</code> 是微软为 Word 软件开发的文件格式，其背后是一个国际标准——<a href="http://officeopenxml.com/">Office Open XML</a>（简称 OOXML）。<code class="highlighter-rouge">docx</code> 其实是打包文件，把扩展名从 <code class="highlighter-rouge">docx</code> 改为 <code class="highlighter-rouge">zip</code> 就能使用解压软件打开，看到其中的内容。解压后的文件结构如下所示：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── [Content_Types].xml
├── _rels
├── docProps
│   ├── app.xml
│   └── core.xml
└── word
    ├── _rels
    │   ├── document.xml.rels
    │   └── footnotes.xml.rels
    ├── document.xml
    ├── fontTable.xml
    ├── footnotes.xml
    ├── media
    ├── numbering.xml
    ├── settings.xml
    ├── styles.xml
    ├── theme
    │   └── theme1.xml
    └── webSettings.xml
</code></pre></div></div>

<p>可以看出，大多数都是 XML 文件。我们主要关注其中三个文件：<code class="highlighter-rouge">word/document.xml</code>，<code class="highlighter-rouge">word/styles.xml</code> 和 <code class="highlighter-rouge">word/fontTable.xml</code>。</p>

<ul>
  <li><code class="highlighter-rouge">document.xml</code>：<code class="highlighter-rouge">docx</code> 文件的内容</li>
  <li><code class="highlighter-rouge">styles.xml</code>：<code class="highlighter-rouge">docx</code> 文件的样式</li>
  <li><code class="highlighter-rouge">fontTable.xml</code>：<code class="highlighter-rouge">docx</code> 文件用到的的字体</li>
</ul>

<p><code class="highlighter-rouge">docx</code> 文件基本上做到了表现和内容分离。<code class="highlighter-rouge">document.xml</code> 和 <code class="highlighter-rouge">styles.xml</code> 可以比作 Web 中的 HTML 和 CSS。定制样式时，我们基本上不用修改内容，也就是 <code class="highlighter-rouge">document.xml</code> 文件。下面着重介绍 <code class="highlighter-rouge">styles.xml</code> 文件。</p>

<p><code class="highlighter-rouge">styles.xml</code> 文件的作用相当于 Web 中的 CSS，只不过这是 XML 文件，而且也不使用 CSS 规则定义样式。下面是一个样式示例：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;w:style w:styleId="BodyText" w:type="paragraph"&gt;
    &lt;w:name w:val="Body Text"/&gt;
    &lt;w:basedOn w:val="Normal"/&gt;
    &lt;w:link w:val="BodyTextChar"/&gt;
    &lt;w:pPr&gt;
        &lt;w:spacing w:after="180" w:before="180"/&gt;
    &lt;/w:pPr&gt;
    &lt;w:rPr&gt;
        &lt;w:rFonts w:ascii="Arial" w:cstheme="majorBidi" w:eastAsia="黑体" w:hAnsiTheme="majorHAnsi"/&gt;
        &lt;w:sz w:val="36"/&gt;
    &lt;/w:rPr&gt;
&lt;/w:style&gt;
</code></pre></div></div>

<p><code class="highlighter-rouge">w:styleId</code> 属性的值是内部 ID，<code class="highlighter-rouge">document.xml</code> 文件中的结构需要什么样式，就引用这个 ID 的值，就像是 CSS 中的选择符一样。<code class="highlighter-rouge">w:type</code> 属性是样式的类型，一般只会用到 <code class="highlighter-rouge">paragraph</code>、<code class="highlighter-rouge">character</code> 和 <code class="highlighter-rouge">table</code>。<code class="highlighter-rouge">w:name</code> 元素中 <code class="highlighter-rouge">w:val</code> 属性的值是这个样式在 GUI 应用（Word，Pages 或 OpenOffice 等）中显示的名称。<code class="highlighter-rouge">w:basedOn</code> 元素中 <code class="highlighter-rouge">w:val</code> 的值是这个样式继承的其他样式 ID；这个元素很重要，用于实现块级元素的样式继承。<code class="highlighter-rouge">w:link</code> 元素中 <code class="highlighter-rouge">w:val</code> 的值也是这个样式继承的其他样式 ID，不过这个元素继承的是行内元素的样式。<code class="highlighter-rouge">w:pPr</code> 元素设定的是段落样式，其中 <code class="highlighter-rouge">w:spacing</code> 元素用于设置段前和段后距离，单位是二十分之一英寸。<code class="highlighter-rouge">w:rPr</code> 元素用于设置段落中行内元素的样式，其中 <code class="highlighter-rouge">w:rFonts</code> 元素用于设置字体（可以分别设置中西文字体），<code class="highlighter-rouge">w:sz</code> 元素用于设置字号，单位是二分之一点（pt）。</p>

<p><code class="highlighter-rouge">docx</code> 文件的样式规则乍看起来很复杂，其实也比较易于理解。我想真正让人觉得难懂的，是 XML 结构。虽然如此，我还是不建议直接手写样式。你可以先在 Word 中通过 GUI 创建样式，然后解压 <code class="highlighter-rouge">docx</code> 文件，修改样式，或者把样式复制出来，方便以后重用。</p>

<p>另一个可能需要修改的文件是 <code class="highlighter-rouge">fontTable.xml</code>。这个文件定义 <code class="highlighter-rouge">docx</code> 文件中用到的所有字体。下面是一个字体定义示例：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;w:font w:name="宋体"&gt;
    &lt;w:altName w:val="SimSun"/&gt;
    &lt;w:panose1 w:val="02010600030101010101"/&gt;
    &lt;w:charset w:val="86"/&gt;
    &lt;w:family w:val="auto"/&gt;
    &lt;w:pitch w:val="variable"/&gt;
    &lt;w:sig w:csb0="00040001" w:csb1="00000000" w:usb0="00000003" w:usb1="080E0000" w:usb2="00000010" w:usb3="00000000"/&gt;
&lt;/w:font&gt;
</code></pre></div></div>

<p>字体的定义看起来比样式简单，其实有很多属性的值是使用某种机制生成的，例如 <code class="highlighter-rouge">w:panose1</code> 元素的 <code class="highlighter-rouge">w:val</code> 属性，因此不要自己动手编写。同样，也是先在 Word 中定义好，然后将其复制出来。</p>

<h2>定制方式</h2>

<p>如果只需要定制 <code class="highlighter-rouge">docx</code> 文件的样式，可以准备好 <code class="highlighter-rouge">styles.xml</code> 和 <code class="highlighter-rouge">fontTable.xml</code> 文件，然后替换掉 Pandoc 生成的 <code class="highlighter-rouge">docx</code> 文件中的这两个文件。例如，在命令行中可以执行下述命令替换：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zip -r sample.docx word/styles.xml word/fontTable.xml
</code></pre></div></div>

<p>下面举个定义样式的例子。在一本书中，每一章一般都新起一页，而不是和前一章的内容连在一起。也就是说，新的一章要换页。在 OOXML 中，换页主要由两种方式，这里我们要使用 <code class="highlighter-rouge">w:pageBreakBefore</code> 元素。后面再介绍另一种方式。按照 Pandoc 的生成方式，一章的标题一般是一级标题，所以我们可以在一级标题的样式中加入 <code class="highlighter-rouge">w:pageBreakBefore</code> 元素，在一级标题之前换页，如下所示：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;w:style w:styleId="Heading1" w:type="paragraph"&gt;
    &lt;w:name w:val="Heading 1"/&gt;
    &lt;w:pPr&gt;
      &lt;w:pageBreakBefore/&gt;
    &lt;/w:pPr&gt;
&lt;/w:style&gt;
</code></pre></div></div>

<p>加入这个样式后，在 <code class="highlighter-rouge">docx</code> 文件的每个一级标题之前都会换页。</p>

<h2>过滤器</h2>

<p>有时我们需要手动强制换页，这时该怎么做呢？答案是使用<a href="http://pandoc.org/scripting.html">过滤器</a>。Pandoc 提供了强大的过滤器机制，方便使用者定制。Pandoc 转换文件的过程如下所示：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        pandoc         filter         pandoc
source --------&gt; JSON --------&gt; JSON --------&gt; target
</code></pre></div></div>

<p>因此，我们可以使用过滤器修改 Pandoc 生成的 JSON 中间格式。Pandoc 的过滤器有 <a href="http://github.com/jgm/pandocfilters">Python API</a>、<a href="https://github.com/vinai/pandocfilters-php">PHP API</a> 和 <a href="https://github.com/mvhenderson/pandoc-filter-node">Node/JavaScript API</a>。不过我对这些语言都不熟悉，所以自己写了一个“简陋”的 <a href="https://gist.github.com/AndorChen/a07c591fed685fb7a80c">Ruby API</a>。</p>

<p>下面说明怎么使用过滤器实现手动换页。假设我们在 Markdown 文件中输入 <code class="highlighter-rouge">&lt;!--PAGEBREAK--&gt;</code> 时是想换页。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="nb">require</span> <span class="s1">'pandocfilter'</span>

<span class="n">filter</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">meta</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">'RawBlock'</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'&lt;!--PAGEBREAK--&gt;'</span>
    <span class="n">xml</span> <span class="o">=</span> <span class="sx">%(&lt;w:p&gt;&lt;w:r&gt;&lt;w:br w:type="page"/&gt;&lt;/w:r&gt;&lt;/w:p&gt;)</span>

    <span class="k">return</span> <span class="no">PandocFilter</span><span class="o">::</span><span class="no">Node</span><span class="p">.</span><span class="nf">raw_block</span><span class="p">(</span><span class="s1">'openxml'</span><span class="p">,</span> <span class="n">xml</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">PandocFilter</span><span class="p">.</span><span class="nf">process</span> <span class="o">&amp;</span><span class="n">filter</span>
</code></pre></div></div>

<p>在这个过滤器中，我们把 <code class="highlighter-rouge">&lt;!--PAGEBREAK--&gt;</code> 替换成 OOXML 格式的元素（<code class="highlighter-rouge">raw_block</code> 方法创建的是 <a href="http://hackage.haskell.org/package/pandoc-types-1.12.4.3/docs/Text-Pandoc-Definition.html#v:RawBlock"><code class="highlighter-rouge">RawBlock</code> 元素</a>）。这个元素表示一个段落，但没有内容。换页的关键是 <code class="highlighter-rouge">w:br</code> 元素，当 <code class="highlighter-rouge">w:type</code> 属性的值为 <code class="highlighter-rouge">page</code> 时表示换页。</p>

<p>除了前面举的几个例子之外，我还做了其他定制，这里就不再一一介绍了。</p>

<h2>总结</h2>

<p>虽然我现在基本上实现了所需的 <code class="highlighter-rouge">docx</code> 文件样式，但使用 Markdown + Pandoc 的方式还是让我觉得别扭。Pandoc 虽然很强大，相对也易于定制，但是 Markdown 有其局限性。Markdown 是为了在 Web 中快速书写而创造的，不是为了写书稿。写书稿首选当然是 <a href="http://www.methods.co.nz/asciidoc/">AsciiDoc</a>。</p>

<p>如果有时间的话，我会开发一个 AsciiDoc 到 <code class="highlighter-rouge">docx</code> 的转换程序。当然，这是一个愿景，要知道，<a href="http://www.ecma-international.org/publications/standards/Ecma-376.htm">OOXML 规范</a>（ECMA-376）可是超过五千页啊。</p>

  </main>

  <footer>
    <p class="mt-20 text-center">~~~ EoF. 感谢阅读！~~~</p>
  </footer>
</article>

</main>

<footer class="mt-20">
  <p>&copy;1988-&infin;。如无特殊说明，本站文章基于“<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" title="CC BY-NC-SA 3.0" target="_blank" rel="noopenner">CC BY-NC-SA 3.0</a>”协议发布。</p>
  <p>使用 <a href="https://bridgetownrb.com/" title="Bridgetownrb" target="_blank" rel="noopenner">Bridgetownrb</a> 构建，使用 <a href="https://draculatheme.com/" title="Dracula" target="_blank" rel="noopenner">Dracula</a> 配色，部署在 <a href="https://pages.github.com/" title="GitHub Pages" target="_blank" rel="noopenner">GitHub Pages</a> 上。</p>
  <p>感谢开放的网络世界。</p>
</footer>

</div>
</body>
</html>

