<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>O'Reilly 电子书在多看中没有目录的修正方法 - Andor Chen</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="renderer" content="webkit" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="description" content="安道的个人网站" />
  <meta name="author" content="安道" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link type="application/atom+xml" rel="alternate" href="https://about.ac/feed.xml" title="Andor Chen" />
  <link rel="stylesheet" href="/_bridgetown/static/index.VMVGKUVX.css" />
  <script src="/_bridgetown/static/index.3QSIHARC.js" defer></script>
  
</head>
<body class="bg-dracula-darker text-dracula-light">

<div class="px-6 py-8 md:px-16 lg:px-24 lg:py-16">
  
  <header class="max-w-prose mb-12">
    <div class="flex flex-row">
      <div class="basis-1/6 flex-auto"><a href="/" title="安道"><img src="/assets/images/painting.png" alt="Andor's Avatar" class="rounded-full w-32" /></a></div>
      <div class="basis-5/6 flex-auto self-center"><span class="pl-8 text-4xl font-medium"><a href="/" title="安道">安道</a></span></div>
    </div>
  </header>

  <main>

<div class="mb-4">
  <a href="/" title="首页">首页</a> // <a href="/archive/" title="文章归档">文章归档</a>
</div>


<article class="prose prose-invert">
  <header>
    <h1 class="text-dracula-orange">O&#39;Reilly 电子书在多看中没有目录的修正方法</h1>
    <p>（发布于 2015 年 4 月 6 日）</p>
  </header>

  <main>
    <p>我平时看电子书，尤其是 ePub 格式的电子书，喜欢使用多看，包括我的 Kindle，也刷成了多看的系统。我看的电子书中相当一部分是 O’Reilly 出版社的。但在多看的系统中，O’Reilly 出版社的电子书都没有目录。如果只有一两本是这种情况，有可能是 O’Reilly 的问题。可是，我接触到的所有O’Reilly 出版社的电子书都是如此，所以我猜想可能是多看系统的问题。</p>

<p>鉴于此，我在其他几个 ePub 阅读器中做了测试，包括 iBooks（Mac 和 iPhone）和 Adobe Digital Editions。在这些阅读器中，O’Reilly 出版社的电子书都能正确显示目录。我还使用 <a href="https://github.com/idpf/epubcheck">epubcheck</a> 对 O’Reilly 的电子书做了验证，结果是，完全没问题。</p>

<p>今天，我仔细研究了一下，发现在 O’Reilly 的电子书中，<a href="http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm#Section2.4.1"><code class="highlighter-rouge">toc.ncx</code> 文件</a>中“缺少”一个 <code class="highlighter-rouge">meta</code> 元素：<a href="http://www.niso.org/workrooms/daisy/Z39-86-2005.html#li_406"><code class="highlighter-rouge">dtb:depth</code></a>。我把”缺少“放在了引号中，因为没有这个元素，epubcheck 并没有报错，说明 ePub 规范并不强制要求必须有这个元素。而且，虽然没有这个元素，很多其他 ePub 阅读器都能正确解析目录。所以，多看没有显示目录的原因，我想应该是兼容性不够强。</p>

<p>我在 <code class="highlighter-rouge">toc.ncx</code> 文件中加上了这个 <code class="highlighter-rouge">meta</code> 元素：<code class="highlighter-rouge">&lt;meta name="dtb:depth" content="1"/&gt;</code>，然后重新打包，在多个 ePub 阅读器中做了测试，包括多看系统，都能正确显示目录。而且，我也使用 epubcheck 做了验证，没有错误。</p>

<p>如果你也在使用多看系统，阅读O’Reilly 出版社的电子书觉得没有目录不方便，可以按照下述方法修正：</p>

<ol>
  <li>使用解压缩软件解压 ePub 文件（可能要先把 ePub 文件的扩展名改为 <code class="highlighter-rouge">.zip</code>）;</li>
  <li>打开解压得到的文件夹，在文本编辑器中打开 <code class="highlighter-rouge">OEBPS</code> 子文件夹中的 <code class="highlighter-rouge">toc.ncx</code> 文件；</li>
  <li>在 <code class="highlighter-rouge">head</code> 元素中加上这个 <code class="highlighter-rouge">meta</code> 元素：<code class="highlighter-rouge">&lt;meta name="dtb:depth" content="1"/&gt;</code>；</li>
  <li>最后，重新打包整个文件夹。</li>
</ol>

<p>重新打包时要注意两个问题：</p>

<ul>
  <li>一定要先打包 <code class="highlighter-rouge">mimetype</code> 这个文件；</li>
  <li>而且，这个文件的压缩率必须为 0%。</li>
</ul>

<p>如果你觉得每次都手动修正很麻烦，可以使用我写的 Rake 任务，如下所示。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'fileutils'</span>

<span class="c1"># Usage: rake duokanify file=path/to/sample.epub</span>
<span class="n">desc</span> <span class="s1">'Adds dtb:depth to ncx file in an ePub'</span>
<span class="n">task</span> <span class="ss">:duokanify</span> <span class="k">do</span>
  <span class="k">unless</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]</span>
    <span class="nb">abort</span><span class="p">(</span><span class="s2">"ERROR: Please provide the ePub file path!</span><span class="se">\n</span><span class="s2">exit"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">unless</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'file'</span><span class="p">].</span><span class="nf">end_with?</span><span class="p">(</span><span class="s1">'.epub'</span><span class="p">)</span>
    <span class="nb">abort</span><span class="p">(</span><span class="s2">"ERROR: The file you provided is not an ePub!</span><span class="se">\n</span><span class="s2">exit"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'file'</span><span class="p">])</span>

  <span class="k">unless</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="nb">abort</span><span class="p">(</span><span class="s2">"ERROR: The file you provided is not exists!</span><span class="se">\n</span><span class="s2">exit"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">puts</span> <span class="s1">'Unzipping....'</span>
  <span class="n">dest_dir</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">'.epub'</span><span class="p">)</span>
  <span class="nb">system</span> <span class="s2">"unzip </span><span class="si">#{</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]</span><span class="si">}</span><span class="s2"> -d </span><span class="si">#{</span><span class="n">dest_dir</span><span class="si">}</span><span class="s2">"</span>

  <span class="nb">puts</span>
  <span class="nb">puts</span> <span class="s1">'Normalize....'</span>
  <span class="n">ncx_file</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="s1">'OEBPS'</span><span class="p">,</span> <span class="s1">'toc.ncx'</span><span class="p">)</span>
  <span class="k">unless</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">ncx_file</span><span class="p">)</span>
    <span class="nb">abort</span><span class="p">(</span><span class="s2">"Info: The ePub has no ncx file, needless to normalize.</span><span class="se">\n</span><span class="s2">exit"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">ncx</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">ncx_file</span><span class="p">,</span> <span class="s1">'r+'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span>
    <span class="c1"># puts content.inspect</span>
    <span class="k">if</span> <span class="n">content</span> <span class="o">=~</span> <span class="sr">/meta="dtb:depth"/i</span>
      <span class="nb">abort</span><span class="p">(</span><span class="s2">"Info: The ePub already set dtb:depth, needless to normalize.</span><span class="se">\n</span><span class="s2">exit"</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">parts</span> <span class="o">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'&lt;/head&gt;'</span><span class="p">)</span>
      <span class="n">parts</span><span class="p">.</span><span class="nf">first</span> <span class="o">&lt;&lt;</span> <span class="s1">'&lt;meta name="dtb:depth" content="1"/&gt;'</span>
      <span class="n">f</span><span class="p">.</span><span class="nf">rewind</span>
      <span class="n">f</span><span class="p">.</span><span class="nf">write</span> <span class="n">parts</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'&lt;/head&gt;'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">puts</span>
  <span class="nb">puts</span> <span class="s1">'Rezipping....'</span>
  <span class="n">normalized_file</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">-normalized.epub"</span>
  <span class="no">FileUtils</span><span class="p">.</span><span class="nf">cd</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">system</span> <span class="s2">"zip -0 -X </span><span class="si">#{</span><span class="n">normalized_file</span><span class="si">}</span><span class="s2"> mimetype"</span>
    <span class="nb">system</span> <span class="s2">"zip -9 -r </span><span class="si">#{</span><span class="n">normalized_file</span><span class="si">}</span><span class="s2"> META-INF OEBPS"</span>
  <span class="k">end</span>
  <span class="no">FileUtils</span><span class="p">.</span><span class="nf">cp</span> <span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">normalized_file</span><span class="p">),</span> <span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span>

  <span class="nb">puts</span>
  <span class="nb">puts</span> <span class="s1">'Cleanning....'</span>
  <span class="no">FileUtils</span><span class="p">.</span><span class="nf">rm_rf</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="ss">:secure</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>

  <span class="nb">puts</span>
  <span class="nb">puts</span> <span class="s1">'Done'</span>
  <span class="nb">puts</span> <span class="s2">"Normalized ePub path: ./</span><span class="si">#{</span><span class="n">normalized_file</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>这个 Rake 任务的使用方法是：在命令行中执行 <code class="highlighter-rouge">rake duokanify file=path/to/sample.epub</code>。执行这个命令后会得到一个名为 <code class="highlighter-rouge">sample-normalized.epub</code> 的文件，然后再把这个文件上传到多看中即可。</p>

<p>水平有限，我的这个 Rake 任务写得比较蹩脚，如果你觉得有可以改进的地方（有很多），请访问<a href="https://gist.github.com/AndorChen/8ebfc5821ceac8884416">这个 Gist</a>，给我留言。这个 Rake 任务的最新版会在这个 Gist 中更新。</p>

  </main>

  <footer>
    <p class="mt-20 text-center">~~~ EoF. 感谢阅读！~~~</p>
  </footer>
</article>

</main>

<footer class="mt-20">
  <p>&copy;1988-&infin;。如无特殊说明，本站文章基于“<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" title="CC BY-NC-SA 3.0" target="_blank" rel="noopenner">CC BY-NC-SA 3.0</a>”协议发布。</p>
  <p>使用 <a href="https://bridgetownrb.com/" title="Bridgetownrb" target="_blank" rel="noopenner">Bridgetownrb</a> 构建，使用 <a href="https://draculatheme.com/" title="Dracula" target="_blank" rel="noopenner">Dracula</a> 配色，部署在 <a href="https://pages.github.com/" title="GitHub Pages" target="_blank" rel="noopenner">GitHub Pages</a> 上。</p>
  <p>感谢开放的网络世界。</p>
</footer>

</div>
</body>
</html>

