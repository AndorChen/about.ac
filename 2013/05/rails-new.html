<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"/><title>新建 Rails 程序 - Andor Chen</title><meta name="description" content="安道的个人网站"/><meta name="author" content="安道"/><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.2.0/css/bootstrap.min.css"/><link rel="stylesheet" href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css"/><link rel="stylesheet" href="/assets/style.css"/></head><body><div class="wrapper"><div class="inner"> <header class="site-header clearfix"><div class="avatar"> <a href="/" title="首页"><img src="/assets/images/andor@2x.jpg" width="180" height="180" alt="" title=""/></a></div><h1 class="logo"><a href="/about/" title="关于安道">安道</a></h1> </header><div class="breadcrumbs"> <a href="/" title="首页">首页</a> // <a href="/archive/" title="文章归档">文章归档</a> // 新建 Rails 程序</div><article class="hentry entry post"> <header class="entry-header"><h1 class="entry-title">新建 Rails 程序</h1><p class="entry-meta">发布于2013年5月12日</p> </header><div class="entry-content"><p>本文针对 Rails 4。</p><p>新建 Rails 程序的第一步是，在命令行中执行 <code class="highlighter-rouge">rails new</code> 命令。执行这个命令后到底发生了什么？</p><p>当我们在命令行中输入 <code class="highlighter-rouge">rails new [PATH]</code> 后，命令行先要找到 <code class="highlighter-rouge">rails</code> 这个可执行文件，可以使用 <code class="highlighter-rouge">which</code> 命令查看，具体的路径视安装方式而不同。我使用 <code class="highlighter-rouge">rbenv</code> 管理 Ruby，所以在我的电脑中，<code class="highlighter-rouge">rails</code> 可执行文件的位置在 <code class="highlighter-rouge">~/username/.rbenv/shims/rails</code>。</p><p><code class="highlighter-rouge">rails</code> 这个可执行文件就是 <code class="highlighter-rouge">railties/bin/rails</code>，内容很简单：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="n">git_path</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../../..'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">),</span> <span class="s1">'.git'</span><span class="p">)</span>

<span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="n">git_path</span><span class="p">)</span>
  <span class="n">railties_path</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../../lib'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">)</span>
  <span class="vg">$:</span><span class="p">.</span><span class="nf">unshift</span><span class="p">(</span><span class="n">railties_path</span><span class="p">)</span>
<span class="k">end</span>
<span class="nb">require</span> <span class="s2">"rails/cli"</span>
</code></pre></div><p>第一行是 shebang 声明，其他几行暂且不提，最后一行才是关键，把命令的实现交由 <code class="highlighter-rouge">railties/lib/rails/cli.rb</code>（<a href="https://github.com/rails/rails/blob/4-0-0/railties/lib/rails/cli.rb" title="source">source</a>）。<code class="highlighter-rouge">railties/lib/rails/cli.rb</code> 第 6 行，调用 <code class="highlighter-rouge">Rails::AppRailsLoader.exec_app_rails</code> 方法，在 <code class="highlighter-rouge">railties/lib/rails/app_rails_loader.rb</code> 中定义（<a href="https://github.com/rails/rails/blob/4-0-0/railties/lib/rails/app_rails_loader.rb" title="source">source</a>）。</p><p><code class="highlighter-rouge">exec_app_rails</code> 这个类方法执行一个 <code class="highlighter-rouge">loop</code> 无限循环，直到在当前工作目录或上层目录中找到 <code class="highlighter-rouge">bin/rails</code> 这个可执行文件为止。这个方法的作用是判断 pwd 或上层目录是否为 Rails 程序目录，如果是一个现有的 Rails 程序，则终止执行 <code class="highlighter-rouge">railties/lib/rails/cli.rb</code> 的后续内容。</p><p>现在，假设我们的 pwd 不是既有 Rails 程序目录，执行 <code class="highlighter-rouge">rails new [PATH]</code> 命令，则会跳到 <code class="highlighter-rouge">railties/lib/rails/cli.rb</code> 的第 8 行，，判断 Ruby 的版本，如果小于 1.9.3，便终止命令。Rails 4 推荐使用 Ruby 2.0。</p><p><code class="highlighter-rouge">railties/lib/rails/cli.rb</code> 第 11-16 行，是 <code class="highlighter-rouge">if-else</code> 分支语句，跳过 <code class="highlighter-rouge">if</code> 分支，直接看 <code class="highlighter-rouge">else</code> 分支，加载 <code class="highlighter-rouge">railties/lib/rails/commands/application.rb</code>（<a href="https://github.com/rails/rails/blob/4-0-0/railties/lib/rails/commands/application.rb" title="souece">souece</a>）。这个文件第 3-6 行不会在执行 <code class="highlighter-rouge">rails new</code> 命令是运行，暂且不提。接下来又是一个 <code class="highlighter-rouge">if-else</code> 分支，直接看 <code class="highlighter-rouge">else</code> 分支。</p><p>如果在执行 <code class="highlighter-rouge">rails new</code> 命令时没有指定 <code class="highlighter-rouge">--no-rc</code> 选项的话，会执行第 12-25 行，读取 <code class="highlighter-rouge">~/.railsrc</code> 文件。</p><p>然后，加载所需的生成器文件：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rails/generators'</span>
<span class="nb">require</span> <span class="s1">'rails/generators/rails/app/app_generator'</span>
</code></pre></div><p>第 43 行，才是关键，<code class="highlighter-rouge">Rails::Generators::AppGenerator.start</code>。</p><p>Rails 的生成器是通过 <a href="https://github.com/wycats/thor" title="Thor">Thor</a> 实现的。<code class="highlighter-rouge">Rails::Generators::AppGenerator</code> 的父类如下：<code class="highlighter-rouge">Rails::Generators::AppBase &lt; Rails::Generators::Base &lt; ::Thor::Group</code>。<code class="highlighter-rouge">Thor::Group</code> 的用法可以参考 <a href="https://github.com/wycats/thor/wiki/Groups" title="Thor 的 Wiki">Thor 的 Wiki</a>，简单来说，Group 中定义的实例方法，会按照顺序执行，特别适合用来生成文件。</p><p>调用 <code class="highlighter-rouge">Rails::Generators::AppGenerator.start</code> 方法后，会按照顺序调用如下方法： <code class="highlighter-rouge">create_root</code>，<code class="highlighter-rouge">create_root_files</code>，<code class="highlighter-rouge">create_app_files</code>，<code class="highlighter-rouge">create_bin_files</code>，<code class="highlighter-rouge">create_config_files</code>，<code class="highlighter-rouge">create_boot_file</code>，<code class="highlighter-rouge">create_active_record_files</code>，<code class="highlighter-rouge">create_db_files</code>，<code class="highlighter-rouge">create_lib_files</code>，<code class="highlighter-rouge">create_log_files</code>，<code class="highlighter-rouge">create_public_files</code>，<code class="highlighter-rouge">create_test_files</code>，<code class="highlighter-rouge">create_tmp_files</code>，<code class="highlighter-rouge">create_vendor_files</code>，<code class="highlighter-rouge">finish_template</code>。文件的模板位于 <code class="highlighter-rouge">railties/lib/rails/generators/rails/app/templates/</code> 目录下。</p><p>然后，我们在命令行中就看到了一串说明：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>rails new demo -B
      create
      create  README.rdoc
      create  Rakefile
      create  config.ru
      create  .gitignore
      create  Gemfile
      create  app
      create  app/assets/javascripts/application.js
      create  app/assets/stylesheets/application.css
      create  app/controllers/application_controller.rb
      create  app/helpers/application_helper.rb
      create  app/views/layouts/application.html.erb
      create  app/mailers/.keep
      create  app/models/.keep
      create  app/controllers/concerns/.keep
      create  app/models/concerns/.keep
      create  bin
      create  bin/bundle
      create  bin/rails
      create  bin/rake
      create  config
      create  config/routes.rb
      create  config/application.rb
      create  config/environment.rb
      create  config/environments
      create  config/environments/development.rb
      create  config/environments/production.rb
      create  config/environments/test.rb
      create  config/initializers
      create  config/initializers/backtrace_silencers.rb
      create  config/initializers/filter_parameter_logging.rb
      create  config/initializers/inflections.rb
      create  config/initializers/mime_types.rb
      create  config/initializers/secret_token.rb
      create  config/initializers/session_store.rb
      create  config/initializers/wrap_parameters.rb
      create  config/locales
      create  config/locales/en.yml
      create  config/boot.rb
      create  config/database.yml
      create  db
      create  db/seeds.rb
      create  lib
      create  lib/tasks
      create  lib/tasks/.keep
      create  lib/assets
      create  lib/assets/.keep
      create  log
      create  log/.keep
      create  public
      create  public/404.html
      create  public/422.html
      create  public/500.html
      create  public/favicon.ico
      create  public/robots.txt
      create  <span class="nb">test</span>/fixtures
      create  <span class="nb">test</span>/fixtures/.keep
      create  <span class="nb">test</span>/controllers
      create  <span class="nb">test</span>/controllers/.keep
      create  <span class="nb">test</span>/mailers
      create  <span class="nb">test</span>/mailers/.keep
      create  <span class="nb">test</span>/models
      create  <span class="nb">test</span>/models/.keep
      create  <span class="nb">test</span>/helpers
      create  <span class="nb">test</span>/helpers/.keep
      create  <span class="nb">test</span>/integration
      create  <span class="nb">test</span>/integration/.keep
      create  <span class="nb">test</span>/test_helper.rb
      create  tmp/cache
      create  tmp/cache/assets
      create  vendor/assets/javascripts
      create  vendor/assets/javascripts/.keep
      create  vendor/assets/stylesheets
      create  vendor/assets/stylesheets/.keep
</code></pre></div><p>最后，我们得到了一个 Rails 程序骨架。</p></div><ul class="entry-tags"><li><a class="btn btn-default btn-sm" href="/tags/#rails-ref" title="Rails">Rails</a></li></ul> </article><ul class="pager"><li class="previous"> <a rel="prev" href="/2013/03/ebook-toolset.html" title="制作电子书的工具集">« 上一篇文章</a></li><li class="next"> <a rel="next" href="/2013/12/2013.html" title="2013 年">下一篇文章 »</a></li></ul><footer class="site-footer clearfix"><div class="col-lg-12 col-md-12 col-sm-12 col-xs-12"><ul class="socials"><li><a href="/feed.xml" title="订阅网站更新"><i class="fa fa-rss"></i></a></li><li><a href="mailto:andor.chen.27@gmail.com" title="电子邮件"><i class="fa fa-envelope-o"></i></a></li><li><a href="https://twitter.com/Andor_Chen" title="Twitter" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="http://www.weibo.com/andor27/" title="微博" target="_blank"><i class="fa fa-weibo"></i></a></li><li><a href="https://github.com/AndorChen" title="GitHub" target="_blank"><i class="fa fa-github"></i></a></li><li><a class="douban" href="http://www.douban.com/people/Andor/" title="豆瓣" target="_blank">豆</a></li></ul><p class="copyright">© 1988- 2015。如无特殊说明，本站内容基于“<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" title="CC BY-NC-SA 3.0" target="_blank">CC BY-NC-SA 3.0</a>”发布。</p><p class="powered-by"><a href="http://jekyllrb.com" title="本站使用 Jekyll 生成" target="_blank"><img src="/assets/images/jekyll-logo@2x.png" width="60" height="24" alt="Jekyll Logo" title="本站使用 Jekyll 生成"/></a></p></div> </footer></div></div></body></html>